---
title: "Duvauchelle Population Dynamics"
output:
  pdf_document: default
  html_notebook: default
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "../figs/",dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../results/',fig_path="../figs/")
```

```{r loadLibs, include=FALSE, echo=FALSE}
library(scales)
library(knitr)
library(dplyr)
library(magick)
library(tidyr)
library(lme4)
library(leaflet)
library(mapview)
```

```{r spfTools}
tmp<-sapply(list.files(path="../../spfTools/R/",full.names = TRUE),source)
multi_tapply<-function(dat,focalCol,factors,FUN,...){
  
  fac<-NULL
  for(i in 1:length(factors)){
    fac<-paste(fac,dat[,factors[i]])
  }
  val<-tapply(dat[,focalCol],
                     fac,
                     match.fun(FUN),...)
  output<-data.frame(matrix(nrow=length(val),ncol=length(factors)+1))
  output[,1]<-val
  for(i in 1:length(factors)){
    output[,i+1]<-unlist(lapply(strsplit(names(val)," "), `[[`, i+1) )
      
      
  }
  colnames(output)<-c("value",factors)
  return(output)

}
```


```{r}
cleandat<-read.csv("../data/cleanedCommunity.csv")
seasonCols<-c(Spring="coral",Summer="olivedrab3",Fall="gold",Winter="dodgerblue")
seagrassCs<-c(bare="#d9f0a3",sparse="#78c679",patchy="#41ab5d",dense="#005a32")
size_cols<-c("#a6bddb","#74a9cf","#2b8cbe","#045a8d")
```



```{r getGPS}
gpsdat<-read.csv("../data/gpsdat.csv")
```

```{r}
lat <- c(-43.794,-43.752) #define our map's ylim
lon <- c(172.930,172.933) #define our map's xlim
center <- c(mean(c(gpsdat$lat_start,gpsdat$lat_stop)), 
            mean(c(gpsdat$long_start,gpsdat$long_stop)))  #tell what point to center on
zoom <- 16  #zoom: 1 = furthest out (entire globe), larger numbers = closer in

```


# Flounder

```{r getFlounderDat}

flounder<-cbind(cleandat[,c("Day","Season","towArea","seagrass_cover",
                            "lat_start","long_start","lat_stop","long_stop")],
                        cleandat[,grep("flounder",colnames(cleandat))])

flounder_long <- gather(flounder, size, count, 9:12, factor_key=TRUE)
flounder_long$size<-factor(gsub("flounder_","",flounder_long$size),
                           levels = c("below10mm","10to20mm","20to50mm","above50mm"))
flounder_long$density<-flounder_long$count/flounder_long$towArea
flounder_long$Season<-factor(flounder_long$Season,
                             levels=c("Winter","Spring","Summer","Fall"))
flounder_long$seagrass_cover<-factor(flounder_long$seagrass_cover,
                                     levels=c("bare","sparse","patchy","dense"))
```

```{r}
par(mfrow=c(2,2))
plot(as.Date(flounder$Day),flounder$flounder_below10mm)
plot(as.Date(flounder$Day),flounder$flounder_10to20mm)
plot(as.Date(flounder$Day),flounder$flounder_20to50mm)
plot(as.Date(flounder$Day),flounder$flounder_above50mm)

```



```{r}
par(mfrow=c(2,2),mar=c(3,4,3.5,2),oma=c(3,2,1,2))
for(i in 1:length(seasonCols)){
  sdat<-flounder_long[flounder_long$Season %in% names(seasonCols)[i],]
  stripchart(sdat$count~sdat$size,
           vertical=TRUE,
           method="jitter",
           jitter=0.05,
           ylab="Number of fish",
           pch=1,
           frame.plot=FALSE,
           axes=FALSE,
           col=seasonCols[i],
           main= names(seasonCols)[i],
           cex.lab=1.2,
           ylim=c(0,50),
           cex=1.5)
  text(x=0.5:3.5,
       y= par("usr")[3] - 15,
       labels = levels(sdat$size),
       xpd = NA,
       srt = 35,
       cex=1.2)
  axis(2,las=2,cex=1.5)
}


```



```{r}
flounderCnts<-data.frame(count=tapply(flounder_long$count,
                     paste(flounder_long$seagrass_cover,
                           flounder_long$Day,
                           flounder_long$Season,
                           flounder_long$size),
                     sum))
flounderCnts$SeagrassCover<-gsub("(\\w+) (\\d+.*) (\\w+) (.*$)","\\1",rownames(flounderCnts))
flounderCnts$Date<-gsub("(\\w+) (\\d+.*) (\\w+) (.*$)","\\2",rownames(flounderCnts))
flounderCnts$Season<-gsub("(\\w+) (\\d+.*) (\\w+) (.*$)","\\3",rownames(flounderCnts))
flounderCnts$SizeClass<-gsub("(\\w+) (\\d+.*) (\\w+) (.*$)","\\4",rownames(flounderCnts))


flounderMeanCnts<-multi_tapply(flounderCnts,"count",c("SeagrassCover","Season","SizeClass"),mean)
flounderMeanCnts$SizeClass<-factor(flounderMeanCnts$SizeClass,
                                   levels=c(
                                     "below10mm",
                                     "10to20mm",
                                     "20to50mm",
                                     "above50mm"
                                   ))
flounderMeanCnts$Season<-factor(flounderMeanCnts$Season,
                                levels=c(
                                  "Winter",
                                  "Spring",
                                  "Summer",
                                  "Fall"
                                ))

flounderSEMCnts<-multi_tapply(flounderCnts,"count",c("SeagrassCover","Season","SizeClass"),sem)
flounderSEMCnts$SizeClass<-factor(flounderSEMCnts$SizeClass,
                                   levels=c(
                                     "below10mm",
                                     "10to20mm",
                                     "20to50mm",
                                     "above50mm"
                                   ))
flounderSEMCnts$Season<-factor(flounderSEMCnts$Season,
                                levels=c(
                                  "Winter",
                                  "Spring",
                                  "Summer",
                                  "Fall"
                                ))

```

```{r}
seagrassPlot<-function(flounderMeanCnts,flounderSEMCnts,cover){
  plot(as.numeric(flounderMeanCnts$Season[flounderMeanCnts$SeagrassCover %in% cover]),
     flounderMeanCnts$value[flounderMeanCnts$SeagrassCover %in% cover],
     type='n',xlab="",ylab="",axes=FALSE,
     ylim=c(0,100),
     cex.lab=2
     )
  axis(1,
       labels = levels(flounderMeanCnts$Season),
       at=1:4,
       pos=0,
       cex.axis=2, 
       las=2)
  axis(2,las=1,cex.axis=2)
  cnt=0
  for(size in levels(flounderMeanCnts$SizeClass)){
    
    subMean<-flounderMeanCnts[flounderMeanCnts$SeagrassCover %in% cover & 
                             flounderMeanCnts$SizeClass %in% size,]
    subMean<-subMean[order(levels(subMean$Season)),]
    xs<-as.numeric(subMean$Season)
    
    subSEM<-flounderSEMCnts[flounderMeanCnts$SeagrassCover %in% cover & 
                             flounderMeanCnts$SizeClass %in% size,]
    arrows(x0=xs,
           x1=xs,
           y0=subMean$value-subSEM$value,
           y1=subMean$value+subSEM$value,
          col=scales::alpha(size_cols[cnt+1],0.5),
          lwd=2,code=3,length=0,xpd=FALSE)
    
    
    cnt<-cnt+1
  }
  cnt=0
  for(size in levels(flounderMeanCnts$SizeClass)){
    
    subMean<-flounderMeanCnts[flounderMeanCnts$SeagrassCover %in% cover & 
                             flounderMeanCnts$SizeClass %in% size,]
    subMean<-subMean[order(levels(subMean$Season)),]
    xs<-as.numeric(subMean$Season)
    
    points(xs,
           subMean$value,pch=cnt+15,col=size_cols[cnt+1],cex=3)
     points(xs,
           subMean$value,type='l',col=size_cols[cnt+1],cex=3)
    
    cnt<-cnt+1
  }
}

```

```{r makeFlounderPlots,eval=FALSE}
png("../figs/flounderPlots.png",width = 1512, height = 300, res = 96)
par(mfrow=c(1,4), oma=c(5,0,2,1), mar=c(2,5.5,1,1),xpd=TRUE)
seagrassPlot(flounderMeanCnts,flounderSEMCnts,"bare")
mtext("Number of flounder",2,outer=FALSE,cex = 1.5,line=3.75)
seagrassPlot(flounderMeanCnts,flounderSEMCnts,"sparse")
seagrassPlot(flounderMeanCnts,flounderSEMCnts,"patchy")
seagrassPlot(flounderMeanCnts,flounderSEMCnts,"dense")

outer_legend("top",bty='n',pch=15:18,col=size_cols,levels(flounderMeanCnts$SizeClass),ncol=4,cex=2,lwd=2)
dev.off()
```
```{r getImages}
bare <- image_read('../figs/seagrass_cover_images/Bare.PNG')
bare_png <- image_convert(bare, "png")

sparse <- image_read('../figs/seagrass_cover_images/Sparse.PNG')
sparse_png <- image_convert(sparse, "png")

patchy <- image_read('../figs/seagrass_cover_images/Patchy.PNG')
patchy_png <- image_convert(patchy, "png")

dense <- image_read('../figs/seagrass_cover_images/Dense.PNG')
dense_png <- image_convert(dense, "png")


seagrassPhotos<-image_append(image_scale(c(
  bare_png,
  sparse_png,
  patchy_png,
  dense_png
)))
```

```{r}
flounderfig<-image_convert(image_read("../figs/flounderPlots.png"), "png")
flounderSeagrass<-image_append(c(flounderfig,
                                 seagrassPhotos), 
                               stack = TRUE)
image_write(flounderSeagrass,
            path = "../figs/FlounderSeagrass.png",
            format = "png")
```


```{r makeSpeciesMap}

long<-rowMeans(flounder[,c("long_start","long_stop")])
lat<-rowMeans(flounder[,c("lat_start","lat_stop")])

# small  
m <- leaflet() %>%
     addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
    #addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = rowMeans(flounder_long[flounder_long$size=="below10mm",
                                            c("long_start","long_stop")]),
               lat = rowMeans(flounder_long[flounder_long$size=="below10mm",
                                       c("lat_start","lat_stop")]),
               weight = 1,
               radius = 1*flounder_long[flounder_long$size=="below10mm","count"],
               col=jsonlite::toJSON(seasonCols[flounder_long[flounder_long$size=="below10mm","Season"]]))
  
m

# 10 to 20
m <- leaflet() %>%
     addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
    #addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = rowMeans(flounder_long[flounder_long$size=="10to20mm",
                                            c("long_start","long_stop")]),
               lat = rowMeans(flounder_long[flounder_long$size=="10to20mm",
                                       c("lat_start","lat_stop")]),
               weight = 1,
               radius = 1*flounder_long[flounder_long$size=="10to20mm","count"],
               col=jsonlite::toJSON(seasonCols[flounder_long[flounder_long$size=="10to20mm","Season"]]))
  
m

# 20 to 50
m <- leaflet() %>%
     addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
    #addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = rowMeans(flounder_long[flounder_long$size=="20to50mm",
                                            c("long_start","long_stop")]),
               lat = rowMeans(flounder_long[flounder_long$size=="20to50mm",
                                       c("lat_start","lat_stop")]),
               weight = 1,
               radius = 1*flounder_long[flounder_long$size=="20to50mm","count"],
               col=jsonlite::toJSON(seasonCols[flounder_long[flounder_long$size=="20to50mm","Season"]]))
  
m

# large ones
m <- leaflet() %>%
     addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
    #addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = rowMeans(flounder_long[flounder_long$size=="above50mm",
                                            c("long_start","long_stop")]),
               lat = rowMeans(flounder_long[flounder_long$size=="above50mm",
                                       c("lat_start","lat_stop")]),
               weight = 1,
               radius = 1*flounder_long[flounder_long$size=="above50mm","count"],
               col=jsonlite::toJSON(seasonCols[flounder_long[flounder_long$size=="above50mm","Season"]]))
  
m


```

```{r }
cleandat$flounder<-rowSums(cleandat[,grep("flounder",colnames(cleandat))])
make_species_map(gpsdat,cleandat,"flounder",center,zoom,scale = 1)
```


## Flounder GLM


Do flounder of different sizes have different abundances throughout the year AND in different seagrass beds?

Looking at patterns of counts (Fig. \@ref(fig:ExploreFlounderPlots)), we can see that the flounder counts do seem to vary with the variables. 



```{r}
fglm<-glm(flounder_long$count ~ 1+ flounder_long$Day * flounder_long$seagrass_cover * flounder_long$size, offset=log(flounder_long$towArea), family="quasipoisson")

par(mfrow=c(2,2))
plot(fglm)

par(mfrow=c(1,5))
plot(flounder_long$count,fglm$residuals)
plot(as.numeric(as.factor(flounder_long$Season)),fglm$residuals)
plot(as.numeric(as.factor(flounder_long$seagrass_cover)),fglm$residuals)
plot(as.numeric(as.factor(flounder_long$size)),fglm$residuals)
plot(flounder_long$towArea,fglm$residuals)
```

```{r}
flounderGLM8<-MASS::glm.nb(flounder_long$count ~ 1+ flounder_long$seagrass_cover/flounder_long$Season  * flounder_long$size *flounder_long$towArea)


par(mfrow=c(1,5))
plot(flounder_long$count,flounderGLM8$residuals)
plot(as.factor(flounder_long$Season),flounderGLM8$residuals)
plot(as.factor(flounder_long$seagrass_cover),flounderGLM8$residuals)
plot(as.factor(flounder_long$size),flounderGLM8$residuals)
plot(flounder_long$towArea,flounderGLM8$residuals)
```

```{r}
flounderGLM8<-MASS::glm.nb(flounder_long$density ~ 1+ flounder_long$Season * flounder_long$seagrass_cover * flounder_long$size + flounder_long$towArea)


par(mfrow=c(1,5))
plot(flounder_long$count,flounderGLM8$residuals)
plot(as.factor(flounder_long$Season),flounderGLM8$residuals)
plot(as.factor(flounder_long$seagrass_cover),flounderGLM8$residuals)
plot(as.factor(flounder_long$size),flounderGLM8$residuals)
plot(flounder_long$towArea,flounderGLM8$residuals)
```

Unfortunately there are some really large deviations from the assumptions of the homogeneity of variances in the residuals. What if I transform the data and use a linear model instead?

```{r}

flounderLM<-lm(density ~ 1+ Season * seagrass_cover * size * towArea, data=flounder_long)
plot(flounderLM)
```

this is slightly better, but the scale-location plot is a bit troubling, and there are some clear outliers...


```{r}
outliers<-car::outlierTest(flounderLM)
outRows<-as.numeric(names(outliers$rstudent))
flounderLMoutrem<-lm(density ~ 1+ Season * seagrass_cover * size * towArea,
                     data=flounder_long[-outRows,])
plot(flounderLMoutrem)
```

nope, that's still not great. 

```{r}
flounderLMsqrt<-lm(sqrt(density) ~ 1+ Season * seagrass_cover * size * towArea, data=flounder_long)
plot(flounderLMsqrt)
```


Check if covariates are highly correlated:

```{r}
plot(flounder_long[,c("Season","seagrass_cover","size","towArea")])
```

(they're not).

```{r, eval=FALSE}
covariates <- names(Solea)[!( names(Solea) %in% c("Sample", "Area", "Solea_solea"))]

getBetaAndSe <- function(covar)
    coef(summary(glm(Solea_solea ~ Solea[[covar]], data = Solea, family = "binomial")))[2,1:2]

# a Loop:
beta.table <- data.frame(variable = covariates, estimate = NA, se = NA)
for(i in 1:length(covariates))
    beta.table[i,2:3] <- getBetaAndSe(covariates[i])

# plyr and magrittr piping one-liner 
## (Less code, but also less tansparent)
  require(magrittr)
    beta.table2 <- adply(t(covariates), 2, getBetaAndSe) %>% mutate(X1 = covariates)
```
```{r, eval=FALSE}
par(mar = c(3,10,2,2))
beta.table <- mutate(beta.table, low = estimate - 2 * se, high = estimate + 2*se)
n <- nrow(beta.table)
with(beta.table, {
    plot(estimate, 1:n, pch = 19, xlim = c(min(low), max(high)), 
         yaxt = "n", ylab="")
    segments(low, 1:n, high, 1:length(high))
    axis(2, at = 1:n, label = variable, las = 2, cex =0.8)
    abline(v = 0, lwd = 2, lty = 3, col="darkgrey")
})

```

While controlling for sampling dates, and accounting for size classes, flounder were most abundant in fall and least abundant in summer.  
(what about seagrass cover?)




# Pipefish

Questions:

- Are pipefish associated with particular habitat types?
- perhaps intertidal vs subtidal?
- When are pipefish breeding during the year?
- Do the two species differ in these patterns?


```{r makeSpeciesMap}
make_2spp_map<-function(gpsdat,
                        species1dat,
                        species2dat,
                        species1Name,
                        species2Name,
                        center,
                        zoom,
                        color=c("yellow","blue"),
                        scale=5){
  long1<-rowMeans(gpsdat[gpsdat$TowNum %in% species1dat$TowNum,
                       c("long_start","long_stop")])
  lat1<-rowMeans(gpsdat[gpsdat$TowNum %in% species1dat$TowNum,
                       c("lat_start","lat_stop")])
  radius1<-species1dat[,species1Name]
  
  long2<-rowMeans(gpsdat[gpsdat$TowNum %in% species2dat$TowNum,
                       c("long_start","long_stop")])
  lat2<-rowMeans(gpsdat[gpsdat$TowNum %in% species2dat$TowNum,
                       c("lat_start","lat_stop")])
  radius2<-species2dat[,species2Name]
  
  m <- leaflet() %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
     #addProviderTiles("NASAGIBS.ViirsEarthAtNight2012")
    addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = long1, lat = lat1, weight = 1,
      radius = radius1*scale,col=color[1])%>%
    addCircles(lng = long2, lat = lat2, weight = 1,
      radius = radius2*scale,col=color[2]) 
  
  m
  return(m)
}

```

```{r stigmatopora}
stigmatopora<-cleandat[cleandat$s.nigra_above50mm>0,]
leptonotus<-cleandat[cleandat$leptonotus_above50mm>0,]
m<-make_2spp_map(gpsdat,
                 stigmatopora,
                 leptonotus,
                 "s.nigra_above50mm",
                 "leptonotus_above50mm",
                 center,
                 15,
                 c("#ffffb3","#8dd3c7"),
              scale=10)
m %>%
    addLegend("bottomright", 
            colors = c("#ffffb3","#8dd3c7"), 
            labels = c("Stigmatopora nigra","Leptonotus elevatus"),
    title = "Species",
    opacity = 1
  )
mapshot(m, file = "../figs/pipefishMap.png")

```


### S. nigra


```{r, eval=FALSE}
png("../figs/DuvauchelleTrends.png",height=6,width=6,units="in",res=300)
par(mfrow=c(2,1),oma=c(1,1,1,1),mar=c(4,4,1,1))
# counts
plot(cnts$juvenile~cnts$date,las=2,
     xlab="",ylab="Number of individuals",
     pch=0,lty=2,lwd=2,cex=2,xaxt='n',bty='n',
     col="dark grey",ylim=c(0,25))
lines(cnts$juvenile~cnts$date,lwd=2,lty=2,col="dark grey")
axis(1,pos=0,labels=cnts$date,at=cnts$date,las=2)

points(cnts$female~cnts$date,
       lwd=2,cex=2,col="#af8dc3")
lines(cnts$female~cnts$date,lwd=2,lty=3,col="#af8dc3")

points(cnts$male~cnts$date,pch=2,
       lwd=2,cex=2,col="#7fbf7b")
lines(cnts$male~cnts$date,lwd=2,lty=1,col="#7fbf7b")
legend("topleft",c("males","females","juveniles"),
       col=c("#7fbf7b","#af8dc3","dark grey"),
       pch=c(2,1,0),pt.cex =2,lwd=2,lty=c(1,3,2),bty='n')

# sizes
par(mar=c(6,4,1,1))
plot(duv_sizes$SVL_Avg~duv_sizes$date,
        xlab="",las=2,ylab="SVL (mm)",
     col=c("dark grey","#af8dc3","#7fbf7b")[duv_sizes$Sex],
     pch=c(0,1,2)[duv_sizes$Sex],
     xlim=c(min(unique(cnts$date)),max(unique(cnts$date))),
     cex=2,lwd=2,xaxt='n',bty='n',ylim=c(20,80))
abline(h=25,lty=4,col="light grey",lwd=2)
axis(1,at=unique(cnts$date),labels=ymd(unique(cnts$date)),las=2)
dev.off()
```





### all


```{r pipefishDat}
pipecounts<-read.csv("../data/pipefish.counts.csv")


stig_counts<-tapply(pipecounts$S_nigra,pipecounts$Month,sum)
lept_counts<-tapply(pipecounts$Leptonotus,pipecounts$Month,sum)

pipedat<-data.frame(month=names(stig_counts),
                    Snigra_total=stig_counts,
                    Lelevat_total=lept_counts)

pipedat$month<-c("Jan","Feb","Oct","Nov","Dec")
pipedat$Snigra_PregMale<-0
pipedat$Snigra_NonpMale<-0
pipedat$Snigra_Female<-0
pipedat$Snigra_Juvenile<-0

pipedat$Lelevat_PregMale<-0
pipedat$Lelevat_NonpMale<-0
pipedat$Lelevat_Female<-0
pipedat$Lelevat_Juvenile<-0


pipes$Month<-gsub("\\d\\d-(\\w+)-\\d+","\\1",pipes$date_tagged)

# s. nigra
snigra<-pipes[pipes$species=="S. nigra",]
sn_sextab<-table(snigra$Month,snigra$sex)
pipedat[pipedat$month %in% rownames(sn_sextab),
        "Snigra_Female"]<-sn_sextab[
          pipedat$month[pipedat$month %in% rownames(sn_sextab)],
          "female"]
sn_maltab<-table(snigra$Month,snigra$pregnancy_status)
pipedat[pipedat$month %in% rownames(sn_maltab),
        "Snigra_PregMale"]<-sn_maltab[
          pipedat$month[pipedat$month %in% rownames(sn_maltab)],
          "pregnant"]
pipedat[pipedat$month %in% rownames(sn_maltab),
        "Snigra_NonpMale"]<-sn_maltab[pipedat$month[
          pipedat$month %in% rownames(sn_maltab)],
          "not pregnant"]
pipedat$Snigra_Juvenile<-pipedat$Snigra_total-(
  pipedat$Snigra_PregMale+
    pipedat$Snigra_NonpMale+
    pipedat$Snigra_Female)

# l. elevatus
leleva<-pipes[pipes$species=="L. elevatus",]
le_sextab<-table(leleva$Month,leleva$sex)
pipedat[pipedat$month %in% rownames(le_sextab),
        "Lelevat_Female"]<-le_sextab[pipedat$month[
          pipedat$month %in% rownames(le_sextab)],"female"]
le_maltab<-table(leleva$Month,leleva$pregnancy_status)
pipedat[pipedat$month %in% rownames(le_maltab),
        "Lelevat_PregMale"]<-le_maltab[pipedat$month[
          pipedat$month %in% rownames(le_maltab)],"pregnant"]
pipedat[pipedat$month %in% rownames(le_maltab),
        "Lelevat_NonpMale"]<-le_maltab[pipedat$month[
          pipedat$month %in% rownames(le_maltab)],"not pregnant"]
pipedat$Lelevat_Juvenile<-pipedat$Lelevat_total-(
  pipedat$Lelevat_PregMale+
    pipedat$Lelevat_NonpMale+
    pipedat$Lelevat_Female)

```

```{r plotPipefish,fig.width=7,fig.height=6,fig.keep='high',dpi=300}
pipedat<-pipedat[match(c("Oct","Nov","Dec","Jan","Feb"),pipedat$month),]
colors<-c(fem="#fb9a99",juv="#33a02c",preg="#1f78b4",nonp="#a6cee3")

par(mfrow=c(3,1),mar=c(3,3,3,2),oma=c(2.5,3,2.5,1.5))
# all adults vs juveniles
plot(pipedat$Snigra_Juvenile+pipedat$Lelevat_Juvenile,
     xlab = "month",axes=FALSE,ylab="Number of Pipefish",
     pch=0,lty=3,cex=2,col=colors["juv"],ylim=c(0,12))
points(pipedat$Snigra_Juvenile+pipedat$Lelevat_Juvenile,
       type='l',lty=3,lwd=2,col=colors["juv"])
axis(1,labels = c("",pipedat$month),at=0:nrow(pipedat),pos=-.5)
axis(2,at=seq(-10,10),pos=0.85,las=1)
points((pipedat$Snigra_total-pipedat$Snigra_Juvenile)+
         (pipedat$Lelevat_total-pipedat$Lelevat_Juvenile),
       pch=5,col="dark grey",lty=1,cex=2)
points((pipedat$Snigra_total-pipedat$Snigra_Juvenile)+
         (pipedat$Lelevat_total-pipedat$Lelevat_Juvenile),
       type='l',col="dark grey",lty=1,lwd=2)
legend("topright",bty='n',c("Adults","Juveniles"),
       pch=c(5,0),lty=c(1,3),pt.cex=2,lwd=2,col=c("dark grey",colors["juv"]))
legend("topleft",legend = "All pipefish",text.font = 2,bty='n')

# S. nigra
plot(pipedat$Snigra_total,xlab = "month",axes=FALSE,ylab="Number of S. nigra",type = 'n')
axis(1,labels = c("",pipedat$month),at=0:nrow(pipedat),pos=-.5)
axis(2,at=seq(-10,10),pos=0.85,las=1)
# females
points(pipedat$Snigra_Female,pch=19,lty=1,cex=2,col=colors["fem"])
points(pipedat$Snigra_Female,type='l',lty=1,lwd=2,col=colors["fem"])
# males
points(pipedat$Snigra_PregMale,pch=25,bg=colors["preg"],col=colors["preg"],cex=2)
points(pipedat$Snigra_PregMale,type='l',lty=2,lwd=2,col=colors["preg"])
points(pipedat$Snigra_NonpMale,pch=25,bg=colors["nonp"],col=colors["nonp"],cex=2)
points(pipedat$Snigra_NonpMale,type='l',lty=2,lwd=2,col=colors["nonp"])
# juveniles
points(pipedat$Snigra_Juvenile,pch=0,lty=3,cex=2,col=colors["juv"])
points(pipedat$Snigra_Juvenile,type='l',lty=3,lwd=2,col=colors["juv"])
legend("topright",bty='n',ncol=2,
       c("Females","Juveniles","Pregnant Males","Non-pregnant males"),
       pch=c(19,0,25,25),lty=c(1,3,2,2),pt.cex=2,lwd=2,
       col=colors[c("fem","juv","preg","nonp")],
       bg=c(colors[c("fem","juv","preg")],"transparent"))
legend("topleft",legend =expression(italic("Stigmatopora nigra")),
       text.font = 2,bty='n')

# L. elevatus
plot(pipedat$Lelevat_total,xlab = "month",axes=FALSE,ylab="",type = 'n')
axis(1,labels = c("",pipedat$month),at=0:nrow(pipedat),pos=-.5)
axis(2,at=seq(-10,10),pos=0.85,las=1)
# females
points(pipedat$Lelevat_Female,pch=19,lty=1,cex=2,col=colors["fem"])
points(pipedat$Lelevat_Female,type='l',lty=1,lwd=2,col=colors["fem"])
# males
points(pipedat$Lelevat_PregMale,pch=25,bg=colors["preg"],col=colors["preg"],cex=2)
points(pipedat$Lelevat_PregMale,type='l',lty=2,lwd=2,col=colors["preg"])
points(pipedat$Lelevat_NonpMale,pch=25,bg=colors["nonp"],col=colors["nonp"],cex=2)
points(pipedat$Lelevat_NonpMale,type='l',lty=2,lwd=2,col=colors["nonp"])
# juveniles
points(pipedat$Lelevat_Juvenile,pch=0,lty=3,cex=2,col=colors["juv"])
points(pipedat$Lelevat_Juvenile,type='l',lty=3,lwd=2,col=colors["juv"])
legend("topright",bty='n',ncol=2,
       c("Females","Juveniles","Pregnant Males","Non-pregnant males"),
       pch=c(19,0,25,25),lty=c(1,3,2,2),pt.cex=2,lwd=2,
       col=colors[c("fem","juv","preg","nonp")],
       bg=c(colors[c("fem","juv","preg")],"transparent"))
legend("topleft",legend =expression(italic("Leptonotus elevatus")),
       text.font = 2,bty='n')
mtext("Number of pipefish",side=2,outer=TRUE)

```




# Shrimp

```{r}
shrimp<-cleandat[cleandat$shrimp>0,] 

plot(colSums(abund[grep("shrimp",rownames(abund)),]),
     xlab="",ylab="# Shrimp",bty='n',xaxt='n',las=1,
     pch=22,cex=2,ylim=c(100,3000))
lines(colSums(abund[grep("shrimp",rownames(abund)),]))
axis(1,at=c(1:10),labels=colnames(abund),las=2)

```

