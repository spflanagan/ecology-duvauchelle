---
title: "Data processing"
author: "Sarah Flanagan"
date: "16/06/2021"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "./figs/",dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../results/',fig_path="./figs/")
```

```{r loadLibs, include=FALSE, echo=FALSE}
library(scales)
library(knitr)
library(dplyr)
library(tidyr)
library(geosphere)
```

# Community data

```{r}
rawdat<-read.csv("../data/MonthlyRawSampling_Duvauchelle_2020.csv")

# remove unnecessary column
rawdat<-subset(rawdat,select=-X)

```

First, check for NAs that should be zeros

```{r}
rawdat[,17:62][is.na(rawdat[,17:62])]<-0
```

Then add a date column

```{r}
rawdat$Day<-as.Date(
  paste0(
    gsub("^(\\d)$","0\\1",rawdat$Date),
    gsub("^(\\d)$","0\\1",rawdat$Month),
    rawdat$Year),
  format = "%d%m%Y")
```

And group them by season

```{r}
rawdat$Season<-gsub("\\d+-(\\d+)-\\d+","\\1",rawdat$Day)
rawdat$Season[rawdat$Season %in% c("09","10","11")]<-"Spring"
rawdat$Season[rawdat$Season %in% c("12","01","02")]<-"Summer"
rawdat$Season[rawdat$Season %in% c("03","04","05")]<-"Fall"
rawdat$Season[rawdat$Season %in% c("06","07","08")]<-"Winter"
```


Calculate the distance of the tows

```{r}
towArea<-apply(rawdat,1,function(dat){
  towArea<-distm(c(as.numeric(dat["long_start"]),
          as.numeric(dat["lat_start"])),
        c(as.numeric(dat["long_stop"]),
          as.numeric(dat["lat_stop"])))
  towArea<-towArea*1.2
  return(towArea)
})
# turn zeroes into 1s
towArea[which(towArea==0)]<-1

# add to data sheet
rawdat$towArea<-towArea
```

Finally remove any rows with missing seagrass covers

```{r}
rawdat<-rawdat[!is.na(rawdat$seagrass_cover),]
```

Fix inconsistent seagrass cover typing

```{r}
rawdat$seagrass_cover<-tolower(rawdat$seagrass_cover)
rawdat$seagrass_cover[rawdat$seagrass_cover=="spare"]<-"sparse"
```

Remove commas from Comments column

```{r}
rawdat$Comments<-gsub(",","",rawdat$Comments)
```

```{r}
rawdat$TowNum<-rownames(rawdat)
```


```{r}
write.csv(rawdat,"../data/cleanedCommunity.csv",quote=FALSE, row.names = FALSE)
```


Combine columns so that each organism has its a single column

```{r}
combNames<-grep("mm$",colnames(rawdat),value=TRUE)
combNames<-combNames[combNames!="whitebait_below50mm"] # only whitebait instance
combPatts<-unique(gsub("_.*$","",combNames))
combPatts[combPatts=="austrovenus"]<-"venus" # one included 'venus_bivalve'

totals<-as.data.frame(do.call(cbind,lapply(combPatts,function(pattern,dat){
  tot<-rowSums(dat[,grep(pattern,colnames(dat))])
  return(tot)
},dat=rawdat)))
colnames(totals)<-combPatts
colnames(totals)[colnames(totals)=="venus"]<-"austrovenus"
totals$isopod<-rowSums(rawdat[,c("isopod","green_centipede")])

nonCombNames<-colnames(rawdat[,17:62])[!colnames(rawdat[,17:62]) %in% combNames]
nonCombNames<-grep("wrasse",nonCombNames,invert=TRUE,value=TRUE)
nonCombNames<-grep("venus",nonCombNames,invert=TRUE,value=TRUE)
nonCombNames<-nonCombNames[!nonCombNames %in% c("isopod","green_centipede")]
```



Create summary data frame

```{r}
combdat<-data.frame(cbind(
  Date=rawdat$Day,
  Season=rawdat$Season,
  TowNum=rawdat$TowNum,
  TowArea=rawdat$towArea,
  SeagrassCover=rawdat$seagrass_cover,
  totals,
  rawdat[,nonCombNames]
  )
)
```

```{r, eval=FALSE}
write.csv(combdat,"cleanedCombinedCommunity.csv",quote=FALSE, row.names = FALSE)
```
```{r}
combdat<-read.csv("cleanedCombinedCommunity.csv")
```

```{r}
gpsdat<-cbind(TowNum=rownames(rawdat),
              rawdat[,c("long_start","long_stop","lat_start","lat_stop")])
write.csv(gpsdat,"../data/gpsdat.csv",quote=FALSE,row.names=FALSE)
```


## Group to common taxonomic level

Some animals we identified to species, but others we grouped at higher orders. Shrimp in particular were a challenge -- the shrimp species likely included in our counts include:

- *Palaemon affinis* (glass shrimp), family Palaemonidae, infraorder Caridea
- *Alphaeus novazealandiae* or *A. socialis* (snapping shrimp | kowhitiwhiti moana), family alpheidae, infraorder caridea
- *Alope spinifrons* (painted shrimp), family Hippolytidae, infraorder Caridea
- *Pontophilus* or *Parapontophilus* species, infraorder Caridea
- *Hippolyte* spp. (chamaeleon shrimp), family Hippolytidae, infraorder Caridea

Which means infraorder is the lowest taxonomic unit for these animals. To summarize all of our species, see \@ref(tab:taxonomicTable).

```{r taxonomicTable}
names<-read.csv("../data/species_names.csv")
kable(names,booktabs=TRUE)
```


To ensure that the varying levels of lowest taxonomic identification don't impact the results, I'll create a data.frame where all of the animals have been grouped at the level of Order -- so I'll sum up any of the obervations at lower levels.  

```{r}
orders<-combDat
names<-names[match(colnames(orders[,4:ncol(orders)]),names$ID ),]
colnames(orders)[4:ncol(orders)]<-as.character(names$order)

ordAbund<-do.call(cbind,lapply( levels(names$order), function(name,dat){
  
  if(length(which((colnames(dat) %in% name)==TRUE))>1){
    ordAbund<-rowSums(dat[,colnames(dat) %in% name])
    return(ordAbund)
  }else{
    return(dat[,name])
  }
}, dat=orders))
colnames(ordAbund)<-levels(names$order)

ordAbund<-cbind(combDat[,c("Season","SeagrassCover","TowDist")],ordAbund)
```
 
```{r}
ordAbund<-write.csv(ordAbund,"cleanedCommunityOrders.csv",quote=FALSE,row.names = FALSE)
```

 
# Pipefish data

```{r}
lengths<-read.csv("../data/pipefish.lengths.csv")
counts<-read.csv("../data/pipefish.counts.csv")
```


# Other size-classed organisms

```{r}
grep("mm$",colnames(rawdat),value=TRUE)
```

