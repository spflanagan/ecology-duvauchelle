---
title: "Community analysis"
output:
  pdf_document: default
  html_notebook: default
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "../figs/",dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../results/',fig_path="../figs/")
```
```{r loadLibs, include=FALSE, echo=FALSE}
library(scales)
library(knitr)
library(vegan)
library(indicspecies)
library(dplyr)
library(tidyr)
library(leaflet)
library(magick)
source("../R/iDIP.R")
```

```{r getData}
combdat<-read.csv("cleanedCombinedCommunity.csv",stringsAsFactors = TRUE)
levels(combdat$SeagrassCover)<-c("bare","sparse","patchy","dense")
```
```{r}
seasonCols<-c(Spring="coral",Summer="olivedrab3",Fall="gold",Winter="dodgerblue")
seagrassCs<-c(bare="coral",sparse="olivedrab3",patchy="gold",dense="dodgerblue")#c(bare="#ffffcc",sparse="#c2e699",patchy="#78c679",dense="#238443")
seasonPchs<-c(Spring=15,Summer=17,Fall=18,Winter=19)
seagrassPs<-c(bare=16, sparse=18, patchy=17, dense=15)
```


## Community analysis

(add space as a covariate)

### dbrda


```{r}
abunds<-as.matrix(combdat[rowSums(combdat[,6:ncol(combdat)])>4,6:ncol(combdat)])
ys<-combdat[rowSums(combdat[,6:ncol(combdat)])>4,c("SeagrassCover","Season","towArea")]
# change to area, but also maybe include nested date

seasonRDA<-capscale(abunds~SeagrassCover*Season + Condition(towArea), 
                 ys,
                 dist="bray")
```
```{r}
plot(seasonRDA)
anova(seasonRDA,by="terms")
seasonSum<-summary(seasonRDA)
```

These results suggest that season and seagrass cover -- and their interaction -- are important in determining the community in seagrass beds. 




```{r RDAplot, fig.cap="dbRDA plot of the first two axes, which describe >50% of the constrained variation. The colours of points represent seagrass cover categories (bare, sparse, patchy, dense) and the shapes of the points represent the season during which the sample was collected (winter, spring, summer, fall). Overlaid on top are the species, with flounder and shrimp being the most obvious species driving divergence."}

plot(seasonRDA,
     type='none',
     xlab=paste0(
       "CAP1 (",
       round(seasonSum$cont$importance[2,1]*100,2),
       "% of total; ", 
       round(seasonSum$concont$importance[2,1]*100,2),
       "% of constrained)"),
     ylab=paste0(
       "CAP2 (",
       round(seasonSum$cont$importance[2,2]*100,2),
       "% of total; ",
       round(seasonSum$concont$importance[2,2]*100,2),
       "% of constrained)")
     )
points(seasonRDA,
       cex=1.5,
       col=scales::alpha(
         seagrassCs[ys$SeagrassCover],0.5
       ),
       pch=seasonPchs[ys$Season])
text(seasonRDA, scaling = 2, display = "sp") 

par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0, 0, type='n', bty='n', xaxt='n', yaxt='n')
legend("topleft",c("Winter","Spring","Summer","Fall"),
       ncol=4,bty='n',
       pch=c(seasonPchs[c("Winter","Spring","Summer","Fall")]),
       col="grey")

legend("topright",c("bare","sparse","patchy","dense"),
       ncol=4,
       pch=19,
       bty='n',
       col=seagrassCs,
       bg=seagrassCs)
```

### Indicator species analysis

```{r}
coverIndics<-multipatt(abunds,ys$SeagrassCover)
summary(coverIndics)
```

```{r}
seasonIndics<-multipatt(abunds,ys$Season)
summary(seasonIndics)
```


#### exploring indicators

```{r getGPS}
gpsdat<-read.csv("../data/gpsdat.csv")
```

```{r}
lat <- c(-43.794,-43.752) #define our map's ylim
lon <- c(172.930,172.933) #define our map's xlim
center <- c(mean(c(gpsdat$lat_start,gpsdat$lat_stop)), 
            mean(c(gpsdat$long_start,gpsdat$long_stop)))  #tell what point to center on
zoom <- 16  #zoom: 1 = furthest out (entire globe), larger numbers = closer in

```


```{r makeSpeciesMap}
make_species_map<-function(gpsdat,speciesdat,speciesName,
                           center,zoom,color="yellow",
                           scale=5){
  long<-rowMeans(gpsdat[gpsdat$TowNum %in% speciesdat$TowNum,
                       c("long_start","long_stop")])
  lat<-rowMeans(gpsdat[gpsdat$TowNum %in% speciesdat$TowNum,
                       c("lat_start","lat_stop")])
  radius<-speciesdat[,speciesName]
  
  m <- leaflet() %>%
    addTiles() %>%  # Add default OpenStreetMap map tiles
    setView(lng=center[2], lat=center[1],zoom=zoom) %>% 
     #addProviderTiles("NASAGIBS.ViirsEarthAtNight2012")
    addProviderTiles("Esri.WorldImagery") %>%
    addCircles(lng = long, lat = lat, weight = 1,
      radius = radius*scale,col=color)
  
  m
  return(m)
}

```

##### season indicators

```{r kahawai}
kahawai<-combdat[combdat$kahawai>0,]
make_species_map(gpsdat,kahawai,"kahawai",center,zoom)
```
```{r limpets}
limpets<-combdat[combdat$limpets>0,] # not abundant enough
make_species_map(gpsdat,limpets,"limpets",center,zoom)

```
```{r smelt}
# also patchy
smelt<-combdat[combdat$smelt>0,] # lots of smelt on one day
make_species_map(gpsdat,smelt,"smelt",center,zoom)

```

```{r bluecod}
blueCod<-combdat[combdat$blue_cod_juv>0,] # almost all from one day
make_species_map(gpsdat,blueCod,"blue_cod_juv",center,zoom)

```

```{r whitebait}
whitebait<-combdat[combdat$whitebait_below50mm>0,] # almost all from one day
make_species_map(gpsdat,whitebait,"whitebait_below50mm",center,zoom)

```

##### seagrass indicators

```{r arrowCrab}
# not bare
arrowCrab<-combdat[combdat$arrowheadCrab>0,]
make_species_map(gpsdat,arrowCrab,"arrowheadCrab",center,zoom)

```

```{r blenny}
blenny<-combdat[combdat$blenny>0,]
make_species_map(gpsdat,blenny,"blenny",center,zoom,scale=2)

```

```{r stigmatopora}
stigmatopora<-combdat[combdat$s.nigra>0,]
make_species_map(gpsdat,stigmatopora,"s.nigra",center,zoom)

```

```{r whelk}
mudWhelk<-combdat[combdat$mud_whelk>0,]
make_species_map(gpsdat,mudWhelk,"mud_whelk",center,zoom)

```

```{r spotty}
#sparse: also kahawai
spotty<-combdat[combdat$spotty>0,] 
make_species_map(gpsdat,spotty,"spotty",center,zoom)

```

```{r bristleworm}
bristleworm<-combdat[combdat$bristleworm>0,] 
make_species_map(gpsdat,bristleworm,"bristleworm",center,zoom)

```



## Diversity analysis


```{r reformatForDiversity}
# only keep tows with > 0 observations
divdat<-combdat[rowSums(combdat[,6:ncol(combdat)])>0,]
divabunds<-as.matrix(divdat[rowSums(divdat[,6:ncol(divdat)])>0,6:ncol(divdat)])
# relative
relabunds<-decostand(divabunds,method="total",MARGIN = 1)
# densities
divdensities<-divabunds/divdat$TowArea
```


### Rarefaction

```{r}
rarecurve(t(divabunds))
```

```{r, eval=FALSE}
set.seed(8675309)
rars<-lapply(1:999,function(i,dat=divdat){
  dat<-divdat[,6:ncol(divdat)]
  ssz<-sum(dat[which.min(divdat$TowArea),])
  # rarify
  rar<-suppressWarnings(rrarefy(dat,ssz))
  rownames(rar)<-paste(divdat$Date,
                       divdat$Season,
                       divdat$SeagrassCover,
                       sep="_")
  
  return(rar)
})

relrar<-lapply(rars,decostand,method="total",MARGIN=1)
saveRDS(relrar,"rarefiedCommunities.RDS")
```
```{r}
relrar<-readRDS("rarefiedCommunities.RDS")
```


### Hill numbers analysis

Within seagrass pairwise beta diversity
then you'd use those to calculate the upper levels?

Should my abundances be densities? - try it

```{r}
files.sources <- list.files(path = "../R/hierDiversity",full.names = TRUE)
tmp<-sapply(files.sources, source)
```

```{r}
# hierDiversity takes the non-relativized abundances
grps<-as.matrix(cbind(divdat[,c("SeagrassCover","Season")], # least inclusive to most inclusive L->R
            Site="Duvauchelle"))
hierDiversity(divabunds, 
              grps, 
              replace = NULL, 
              reps = 99, 
              q = 1,
              quant = c(0.025, 0.975),
              sims = FALSE)
```





```{r calcQs}
calcQs<-function(relabund){
  q0<-apply(relabund,2,calc_hill,q=0)
  q1<-apply(relabund,2,calc_hill,q=1)
  q2<-apply(relabund,2,calc_hill,q=2)
  
  Qs<-data.frame(q0=q0,q1=q1,q2=q2)  
  return(Qs)
}

```

```{r qsPlot_function}
# assumes the columns are q0,q1,q2 and lab_col is the name of the row with the x-axis labels
qsPlot<-function(Qs,lab_col,qcols=c("#a1dab4","#41b6c4","#225ea8")){

  plot(Qs$q0,type="l",xlab=lab_col,ylab="Species diversity",
     ylim=c(0,max(Qs$q0)+2),cex=2,lwd=2,axes=FALSE,col=qcols[1])
  axis(1,labels=c("",as.character(Qs[,lab_col])),at=0:nrow(Qs))
  axis(2,las=2,seq(-10,max(Qs$q0)+5,5))
  points(Qs$q0,pch=19,cex=2,lwd=2,col=qcols[1])
  text(1,Qs$q0[1]-1,"q=0",font = 3,col=qcols[1])
  
  points(Qs$q1,pch=16,col=qcols[2],cex=2,lwd=2)
  points(Qs$q1,lty=2,col=qcols[2],type='l',lwd=2)
  text(1,Qs$q1[1]+1,"q=1",col=qcols[2],font = 3)
  
  points(Qs$q2,pch=17,col=qcols[3],cex=2,lwd=2)
  points(Qs$q2,lty=3,col=qcols[3],type='l',lwd=2)
  text(1,Qs$q2[1]-1,"q=2",col=qcols[3],font = 3)
}
```


```{r DuvauchelleQsbyDate}
# add column names
colnames(divabunds)<-divdat$Date

# calculate relative abundance
relabund<-calc_relabund(divabunds)

Qs<-calcQs(relabund)
Qs$date<-rownames(Qs)

Qs<-Qs[order(Qs$date),]

qsPlot(Qs,"date")

```


```{r}

rareQ<-function(divdat,group="Date"){
  # get minimum sample size
  ssz<-sum(divdat[which.min(divdat$TowDist),])
  # rarify
  rar<-suppressWarnings(rrarefy(abunds,ssz))
  # Add group labels
  colnames(divabunds)<-paste(divdat$Date,
                             divdat$Season,
                             divdat$SeagrassCover,
                             sep="_")
  # relative abundances
  relabund<-calc_relabund(divabunds)
  # calculate Hill numbers
  Qs<-calcQs(relabund)
  
  return(Qs)
}

```

#### Compare diversity indices across seagrass cover 


```{r reformatCover}

divabunds<-as.matrix(divdat[rowSums(divdat[,6:ncol(divdat)])>0,6:ncol(divdat)])
# flip the dataset
divabunds<-t(divabunds)

# add column names
colnames(divabunds)<-paste(divdat$Date,divdat$Season,divdat$SeagrassCover,sep="_")


# combine samples from the same days 
# https://stackoverflow.com/questions/35626945/row-wise-sum-of-values-grouped-by-columns-with-same-name
abund<-t(rowsum(t(divabunds), group = colnames(divabunds), na.rm = T))
relabund<-sapply(1:ncol(abund),function(k)	abund[,k]/sum(abund[,k]))
colnames(relabund)<-colnames(abund)

```


```{r calcQsCover}
q0<-apply(relabund,2,calc_hill,q=0)
q1<-apply(relabund,2,calc_hill,q=1)
q2<-apply(relabund,2,calc_hill,q=2)

Qs<-data.frame(q0=q0,q1=q1,q2=q2)
Qs$date<-as.Date(gsub("(\\d+)_\\w+_\\w+","\\1",rownames(Qs)))

Qs<-Qs[order(Qs$date),]
```


```{r DuvQs_Cover,fig.width=8,fig.height=6,fig.keep='high',dpi=300}

par(mfrow=c(1,4),oma=c(2.5,2.5,2.5,1.5),mar=c(3,3,3,2))
qsPlot(Qs[grep("bare",rownames(Qs)),],"date")
legend("topleft","Bare",bty='n')

qsPlot(Qs[grep("sparse",rownames(Qs)),],"date")
legend("topleft","Sparse",bty='n')

qsPlot(Qs[grep("patchy",rownames(Qs)),],"date")
legend("topleft","Patchy",bty='n')

qsPlot(Qs[grep("dense",rownames(Qs)),],"date")
legend("topleft","Dense Seagrass",bty='n')

mtext("Species Diversity",2,outer=TRUE)
```


## Summaries

I can create a graph showing the numbers of species for each type of seagrass habitats.

```{r}
duvSummary<-data.frame(
  Status=paste(combdat$Season,combdat$seagrass_cover,sep="_"),
  Leptonotus=combdat$L.elevatus,
  Stigmatopora=combdat$S.nigra,
  Shrimp=combdat$Shrimp_spp,
  Flounder=combdat$Flounder,
  Crabs=rowSums(combdat[,25:30]),
  Snails=rowSums(combdat[,33:38]),
  OtherFish=rowSums(combdat[,17:23]),
  Other=rowSums(combdat[,c(31,32,39:34)])
  )

```

```{r}
duvCounts<-as.data.frame(duvSummary %>%
  group_by(Status) %>%
  summarise_all( sum))
```

```{r}

bareLept<-barplot(duvCounts[grep("Bare",duvCounts$Status),2],col = seasonCols)

barplot(duvCounts[grep("Bare",duvCounts$Status),3])


barplot(duvCounts[grep("Bare",duvCounts$Status),4],col = seasonCols)




```

```{r}
sppCols<-c('#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462')
spp<-colnames(duvSummary)[4:9]
```

```{r}
CountsPlot<-function(summaryMatrix, spp, sppCols,x.lim=c(0,7),y.lim=c(0,300)){
  
  
  plot(rep(1,nrow(summaryMatrix)),
       summaryMatrix[,1],
       xlim=x.lim,
       ylim=y.lim,
       xlab="",
       ylab="Counts",
       axes=F,
       type='n')
  axis(1,at=1:length(spp),labels=spp,lty = 0,las=2)
  axis(2,las=1)
  
  
  for(i in 1:length(spp)){
    points(rep(i,length(summaryMatrix[,spp[i]])),
       summaryMatrix[,spp[i]],
       pch=21,
       bg=scales::alpha(sppCols[i],0.75),
       col="dark grey",
       cex=2.5)
    lines(x=c(i-0.25,i+0.25),
          y=c(mean(summaryMatrix[,spp[i]]),
              mean(summaryMatrix[,spp[i]])),
          lwd=4,
          col=sppCols[i])
  }
}
```


```{r seagrassPlots}

par(mfrow=c(1,4))
CountsPlot(duvSummary[grep("Bare",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Sparse",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Patchy",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Dense",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)

```



```{r seasonPlots}

par(mfrow=c(1,4))
CountsPlot(duvSummary[grep("Spring",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Summer",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Autumn",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Winter",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)

```


```{r getImages}
bare <- image_read('../figs/seagrass_cover_images/Bare.PNG')
bare_png <- image_convert(bare, "png")

sparse <- image_read('../figs/seagrass_cover_images/Sparse.PNG')
sparse_png <- image_convert(sparse, "png")

patchy <- image_read('../figs/seagrass_cover_images/Patchy.PNG')
patchy_png <- image_convert(patchy, "png")

dense <- image_read('../figs/seagrass_cover_images/Dense.PNG')
dense_png <- image_convert(dense, "png")


image_append(image_scale(c(
  bare_png,
  sparse_png,
  patchy_png,
  dense_png
)))
```









