---
title: "Community analysis"
output:
  pdf_document: default
  html_notebook: default
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra='',fig.pos="H",
                      fig.path = "../figs/",dpi = 300,fig.keep='last',dev='png')
knitr::opts_knit$set(root.dir='../results/',fig_path="./figs/")
```
```{r loadLibs, include=FALSE, echo=FALSE}
library(scales)
library(knitr)
library(vegan)
library(indicspecies)
library(HierDpart)
source("../R/iDIP.R")
```

```{r getData}
combdat<-read.csv("cleanedCommunity.csv",stringsAsFactors = TRUE)
levels(combdat$SeagrassCover)<-c("bare","sparse","patchy","dense")
```
```{r}
seasonCols<-c(Spring="coral",Summer="olivedrab3",Fall="gold",Winter="dodgerblue")
seagrassCs<-c(bare="coral",sparse="olivedrab3",patchy="gold",dense="dodgerblue")#c(bare="#ffffcc",sparse="#c2e699",patchy="#78c679",dense="#238443")
seasonPchs<-c(Spring=15,Summer=17,Fall=18,Winter=19)
seagrassPs<-c(bare=16, sparse=18, patchy=17, dense=15)
```

## Community analysis


### dbrda


```{r}
abunds<-as.matrix(combdat[rowSums(combdat[,6:ncol(combdat)])>4,6:ncol(combdat)])
ys<-combdat[rowSums(combdat[,6:ncol(combdat)])>4,c("SeagrassCover","Season","TowDist")]


seasonRDA<-capscale(abunds~SeagrassCover*Season + Condition(TowDist),
                 ys,
                 dist="bray")
```
```{r}
plot(seasonRDA)
anova(seasonRDA,by="terms")
seasonSum<-summary(seasonRDA)
```

These results suggest that season and seagrass cover -- and their interaction -- are important in determining the community in seagrass beds. 




```{r RDAplot, fig.cap="dbRDA plot of the first two axes, which describe >50% of the constrained variation. The colours of points represent seagrass cover categories (bare, sparse, patchy, dense) and the shapes of the points represent the season during which the sample was collected (winter, spring, summer, fall). Overlaid on top are the species, with flounder and shrimp being the most obvious species driving divergence."}

plot(seasonRDA,
     type='none',
     xlab=paste0(
       "CAP1 (",
       round(seasonSum$cont$importance[2,1]*100,2),
       "% of total; ", 
       round(seasonSum$concont$importance[2,1]*100,2),
       "% of constrained)"),
     ylab=paste0(
       "CAP2 (",
       round(seasonSum$cont$importance[2,2]*100,2),
       "% of total; ",
       round(seasonSum$concont$importance[2,2]*100,2),
       "% of constrained)")
     )
points(seasonRDA,
       cex=1.5,
       col=scales::alpha(
         seagrassCs[ys$SeagrassCover],0.5
       ),
       pch=seasonPchs[ys$Season])
text(seasonRDA, scaling = 2, display = "sp") 
```

### Indicator species analysis

```{r}
coverIndics<-multipatt(abunds,ys$SeagrassCover)
summary(coverIndics)
```

```{r}
seasonIndics<-multipatt(abunds,ys$Season)
summary(seasonIndics)
```


## Diversity analysis

```




```




I can create a graph showing the numbers of species for each type of seagrass habitats.

```{r}
duvSummary<-data.frame(
  Status=paste(combdat$Season,combdat$seagrass_cover,sep="_"),
  Leptonotus=combdat$L.elevatus,
  Stigmatopora=combdat$S.nigra,
  Shrimp=combdat$Shrimp_spp,
  Flounder=combdat$Flounder,
  Crabs=rowSums(combdat[,25:30]),
  Snails=rowSums(combdat[,33:38]),
  OtherFish=rowSums(combdat[,17:23]),
  Other=rowSums(combdat[,c(31,32,39:34)])
  )

```

```{r}
duvCounts<-as.data.frame(duvSummary %>%
  group_by(Status) %>%
  summarise_all( sum))
```

```{r}

bareLept<-barplot(duvCounts[grep("Bare",duvCounts$Status),2],col = seasonCols)

barplot(duvCounts[grep("Bare",duvCounts$Status),3])


barplot(duvCounts[grep("Bare",duvCounts$Status),4],col = seasonCols)




```

```{r}
sppCols<-c('#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462')
spp<-colnames(duvSummary)[4:9]
```

```{r}
CountsPlot<-function(summaryMatrix, spp, sppCols,x.lim=c(0,7),y.lim=c(0,300)){
  
  
  plot(rep(1,nrow(summaryMatrix)),
       summaryMatrix[,1],
       xlim=x.lim,
       ylim=y.lim,
       xlab="",
       ylab="Counts",
       axes=F,
       type='n')
  axis(1,at=1:length(spp),labels=spp,lty = 0,las=2)
  axis(2,las=1)
  
  
  for(i in 1:length(spp)){
    points(rep(i,length(summaryMatrix[,spp[i]])),
       summaryMatrix[,spp[i]],
       pch=21,
       bg=scales::alpha(sppCols[i],0.75),
       col="dark grey",
       cex=2.5)
    lines(x=c(i-0.25,i+0.25),
          y=c(mean(summaryMatrix[,spp[i]]),
              mean(summaryMatrix[,spp[i]])),
          lwd=4,
          col=sppCols[i])
  }
}
```


```{r seagrassPlots}

par(mfrow=c(1,4))
CountsPlot(duvSummary[grep("Bare",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Sparse",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Patchy",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Dense",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)

```



```{r seasonPlots}

par(mfrow=c(1,4))
CountsPlot(duvSummary[grep("Spring",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Summer",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Autumn",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)
CountsPlot(duvSummary[grep("Winter",duvSummary$Status),4:9],spp=spp,sppCols = sppCols)

```


```{r getImages}
bare <- image_read('../figs/seagrass_cover_images/Bare.PNG')
bare_png <- image_convert(bare, "png")

sparse <- image_read('../figs/seagrass_cover_images/Sparse.PNG')
sparse_png <- image_convert(sparse, "png")

patchy <- image_read('../figs/seagrass_cover_images/Patchy.PNG')
patchy_png <- image_convert(patchy, "png")

dense <- image_read('../figs/seagrass_cover_images/Dense.PNG')
dense_png <- image_convert(dense, "png")


image_append(image_scale(c(
  bare_png,
  sparse_png,
  patchy_png,
  dense_png
)))
```




## Reformat data

```{r extractAbundances}
animals<-colnames(dat)[grep("leptonotus_below",colnames(dat)):(ncol(dat)-1)]
# get the abundances
abundance<-t(dat[,animals])
# add column names
colnames(abundance)<-paste("SI",dat$Estuary,dat$Location,dat$DDMMYY,sep="_")
# replace NAs with 0s
abundance[is.na(abundance)]<-0
# remove tows with 0 observations
keepCols<-which(colSums(abundance)>0)
abundance<-abundance[,keepCols]

# combine samples from the same days 
# https://stackoverflow.com/questions/35626945/row-wise-sum-of-values-grouped-by-columns-with-same-name
abund<-t(rowsum(t(abundance), group = colnames(abundance), na.rm = T))

write.table(abundance,"../data/Sep2020_abundances.txt",
            row.names = TRUE,quote=FALSE,col.names = TRUE,sep='\t')
```

```{r extractPopStru}
stru<-t(data.frame(Island=rep("South Island",ncol(abund)),
                   Estuary=gsub("(\\w+)_(\\w+)_(\\d+)","\\1",colnames(abund)),
                 Location=gsub("(\\w+)_(\\w+)_(\\d+)","\\2",colnames(abund)),
                 Date=gsub("(\\w+)_(\\w+)_(\\d+)","\\3",colnames(abund))))

write.table(stru,"../data/Sep2020_structure.txt",
            row.names = FALSE,quote=FALSE,col.names = FALSE,sep='\t')
```

## iDIP analysis


```{r iDIP}
div<-iDIP(abun = abund,struc=stru)
```

Let's reformat for improved interpretation

```{r iDipFormat}
div_dat<-data.frame(Within=c(NA,div["D_alpha.3",],div["D_alpha.2",],div["D_alpha.1",]),
           Between=c(NA,div["D_beta.3",],div["D_beta.2",],div["D_beta.1",]),
           Total=c(div["D_gamma",],div["D_gamma",],div["D_alpha.3",],div["D_alpha.2",]))
kable(div_dat)
```


## Hill numbers analysis

```{r relativeAbund}
relabund<-sapply(1:ncol(abund),function(k)	abund[,k]/sum(abund[,k]))
colnames(relabund)<-colnames(abund)

```

```{r calc_hill}
calc_hill<-function(vec,q){
  qD<-(sum(vec[vec>0]^q))^(1/(1-q))
  if(q==1){
    qD<-exp(-1*sum(vec[vec>0]*log(vec[vec>0])))
  }
  return(qD)
}
```

```{r calcQs}
q0<-apply(relabund,2,calc_hill,q=0)
q1<-apply(relabund,2,calc_hill,q=1)
q2<-apply(relabund,2,calc_hill,q=2)

Qs<-data.frame(q0=q0,q1=q1,q2=q2)
Qs$date<-gsub("\\w+_\\w+_\\w+_(\\d\\d)(\\d\\d?)(\\d\\d\\d\\d)","\\3-\\2-\\1",rownames(Qs))
Qs$date<-gsub("(\\d+-)(\\d)(-\\d+)","\\10\\2\\3",Qs$date)
Qs$date<-gsub("\\w+_\\w+_\\w+_(\\d)(\\d)(\\d\\d\\d\\d)","\\3-0\\2-0\\1",Qs$date)
Qs<-Qs[order(Qs$date),]
```


```{r qsPlot_function}
# assumes the columns are q0,q1,q2 and lab_col is the name of the row with the x-axis labels
qsPlot<-function(Qs,lab_col,qcols=c("#a1dab4","#41b6c4","#225ea8")){

  plot(Qs$q0,type="l",xlab=lab_col,ylab="Species diversity",
     ylim=c(0,max(Qs$q0)+2),cex=2,lwd=2,axes=FALSE,col=qcols[1])
  axis(1,labels=c("",as.character(Qs[,lab_col])),at=0:nrow(Qs))
  axis(2,las=2,seq(-10,max(Qs$q0)+5,5))
  points(Qs$q0,pch=19,cex=2,lwd=2,col=qcols[1])
  text(1,Qs$q0[1]-1,"q=0",font = 3,col=qcols[1])
  
  points(Qs$q1,pch=16,col=qcols[2],cex=2,lwd=2)
  points(Qs$q1,lty=2,col=qcols[2],type='l',lwd=2)
  text(1,Qs$q1[1]+1,"q=1",col=qcols[2],font = 3)
  
  points(Qs$q2,pch=17,col=qcols[3],cex=2,lwd=2)
  points(Qs$q2,lty=3,col=qcols[3],type='l',lwd=2)
  text(1,Qs$q2[1]-1,"q=2",col=qcols[3],font = 3)
}
```

```{r plotDuvauchelleQs}
duvQs<-Qs[grep("Dur",rownames(Qs)),]
qsPlot(duvQs,"date")

```

```{r plotAvonHeathcoteQs,fig.width=7,fig.height=6,fig.keep='high',dpi=300}
par(mfrow=c(2,1),oma=c(2.5,2.5,2.5,1.5),mar=c(3,3,2,2))
AHSSqs<-Qs[grep("AHE_SS",rownames(Qs)),]
qsPlot(AHSSqs,"date")

AHCWqs<-Qs[grep("AHE_CW",rownames(Qs)),]
qsPlot(AHCWqs,"date")
mtext("Species diversity",2,outer=TRUE)

```

### Compare seagrass vs bare 

```{r reformatWithMudvGrass}
animals<-colnames(dat)[grep("Leptonotus",colnames(dat)):(ncol(dat)-1)]
# get the abundances
abundance<-t(dat[,animals])
# add column names
colnames(abundance)<-paste("SI",dat$Estuary,dat$Location,dat$DDMMYY,dat$Mud_vs_Grass,sep="_")
# replace NAs with 0s
abundance[is.na(abundance)]<-0
# remove tows with 0 observations
keepCols<-which(colSums(abundance)>0)
abundance<-abundance[,keepCols]

# combine samples from the same days 
# https://stackoverflow.com/questions/35626945/row-wise-sum-of-values-grouped-by-columns-with-same-name
abund<-t(rowsum(t(abundance), group = colnames(abundance), na.rm = T))
relabund<-sapply(1:ncol(abund),function(k)	abund[,k]/sum(abund[,k]))
colnames(relabund)<-colnames(abund)

```

```{r calcQsMudvGrass,fig.width=7,fig.height=6,fig.keep='high',dpi=300}
q0<-apply(relabund,2,calc_hill,q=0)
q1<-apply(relabund,2,calc_hill,q=1)
q2<-apply(relabund,2,calc_hill,q=2)

Qs<-data.frame(q0=q0,q1=q1,q2=q2)
Qs$date<-gsub("\\w+_\\w+_\\w+_(\\d\\d)(\\d\\d?)(\\d\\d\\d\\d)_\\w+","\\3-\\2-\\1",rownames(Qs))
Qs$date<-gsub("(\\d+-)(\\d)(-\\d+)","\\10\\2\\3",Qs$date)
Qs$date<-gsub("\\w+_\\w+_\\w+_(\\d)(\\d)(\\d\\d\\d\\d)_\\w+","\\3-0\\2-0\\1",Qs$date)
Qs<-Qs[order(Qs$date),]
```


```{r DuvQs_MudvGrass,fig.width=8,fig.height=6,fig.keep='high',dpi=300}
duvQs<-Qs[grep("Dur",rownames(Qs)),]
par(mfrow=c(1,2),oma=c(2.5,2.5,2.5,1.5),mar=c(3,3,3,2))
qsPlot(duvQs[grep("Grass",rownames(duvQs)),],"date")
legend("topleft","Seagrass",bty='n')
qsPlot(duvQs[grep("Bare",rownames(duvQs)),],"date")
legend("topleft","Mud",bty='n')
mtext("Species Diversity",2,outer=TRUE)
```

```{r AHEQs_MudvGrass,fig.width=8,fig.height=6,fig.keep='high',dpi=300}
par(mfrow=c(1,2),oma=c(2.5,2.5,2.5,1.5),mar=c(3,3,3,2))
qsPlot(Qs[grep("AHE_.*_Grass",rownames(Qs)),],"date")
legend("topleft","Seagrass",bty='n')
qsPlot(Qs[grep("AHE_.*_Bare",rownames(Qs)),],"date")
legend("topleft","Mud",bty='n')
mtext("Species Diversity",2,outer=TRUE)
```




